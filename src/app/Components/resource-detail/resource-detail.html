<!-- 
  =============================================
  RESOURCE DETAIL PAGE TEMPLATE
  =============================================
  Displays the full content of a specific wellness resource.
  
  Key Features:
  - Dynamic Layout based on Resource Format (Video vs Audio vs Article vs Website).
  - Custom Audio Player for Podcasts.
  - Embedded Video Player for Videos.
  - HTML Content Renderer for Articles/Guides.
  - Favoriting capability.
-->

<div class="detail-shell">
    <div class="container py-4 py-md-5">

        <!-- =============================================
             1. NAVIGATION (Back Button)
             ============================================= -->
        <div class="mb-3">
            <button type="button" (click)="goBack()" class="btn-back bg-transparent border-0 p-0" aria-label="Go back">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5m7 7l-7-7 7-7" />
                </svg>
                <span>Back to All Resources</span>
            </button>
        </div>


        <!-- =============================================
             2. LOADING STATE
             ============================================= -->
        <div *ngIf="loading()" class="loading-container">
            <div class="loader"></div>
        </div>


        <!-- =============================================
             3. ERROR STATE
             ============================================= -->
        <div *ngIf="error() as errorMessage" class="error-panel">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 9v2m0 4v.01"></path>
                <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75">
                </path>
            </svg>
            <h5 class="h5">An Error Occurred</h5>
            <p class="mb-0 small">{{ errorMessage }}</p>
        </div>


        <!-- =============================================
             4. MAIN CONTENT PANEL
             ============================================= -->
        <div *ngIf="!loading() && resource() as res" class="detail-panel glass">

            <!-- A. Media Header (Cover Image or Icon Placeholder) -->
            <div class="detail-media">
                <div class="media-placeholder">
                    <!-- Format Icon Overlay -->
                    <div class="media-overlay-icon">
                        <ng-container [ngSwitch]="res.format">
                            <svg *ngSwitchCase="'Video'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M22.54 6.42a2.24 2.24 0 0 0-1.76-1.9C18.28 4 12 4 12 4s-6.28 0-8.78.52A2.24 2.24 0 0 0 1.46 6.42a24.2 24.2 0 0 0 0 11.16 2.24 2.24 0 0 0 1.76 1.9c2.5.52 8.78.52 8.78.52s6.28 0 8.78-.52a2.24 2.24 0 0 0 1.76-1.9 24.2 24.2 0 0 0 0-11.16z">
                                </path>
                                <polygon points="9.5 15.5 15.5 12 9.5 8.5 9.5 15.5"></polygon>
                            </svg>
                            <svg *ngSwitchCase="'Podcast'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                            <svg *ngSwitchCase="'Guide'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            <svg *ngSwitchCase="'Website'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path
                                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                                </path>
                            </svg>
                            <svg *ngSwitchDefault viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                </path>
                            </svg>
                        </ng-container>
                    </div>
                    <!-- Background Image -->
                    <img *ngIf="res.thumbnail" [src]="res.thumbnail" (error)="res.thumbnail = undefined" alt=""
                        class="media-img">
                </div>
            </div>


            <!-- B. Resource Body -->
            <div class="detail-body">

                <!-- Header Chips (Category & Format) -->
                <div class="detail-header">
                    <a [routerLink]="['/library']"
                        [queryParams]="{ categories: res.category, search: null, formats: null, sort: null }"
                        class="badge badge-soft badge-interactive me-2">{{ res.category }}</a>

                    <a [routerLink]="['/library']"
                        [queryParams]="{ formats: res.format, search: null, categories: null, sort: null }"
                        class="badge badge-chip badge-interactive" [ngClass]="{ 
                          'chip-video': res.format==='Video', 
                          'chip-article': res.format==='Article', 
                          'chip-podcast': res.format==='Podcast', 
                          'chip-guide': res.format==='Guide', 
                          'chip-website': res.format==='Website' 
                       }">{{ res.format }}</a>
                </div>

                <!-- Title & Description -->
                <h1 class="display-5 fw-bold mb-2">{{ res.title }}</h1>
                <p class="text-muted-app lead fs-6">{{ res.description }}</p>

                <!-- Action Bar (Tags & Favorite Toggle) -->
                <div class="action-bar">
                    <div class="tags-container" *ngIf="res.tags.length">
                        <a *ngFor="let tag of res.tags" class="tag-link" [routerLink]="['/library']"
                            [queryParams]="{ search: tag, categories: null, formats: null, sort: null }">
                            <span class="badge badge-tag">{{ tag }}</span>
                        </a>
                    </div>

                    <button type="button" class="btn btn-action-favorite" [class.active]="isFavorite(res.id)"
                        (click)="store.toggleFavorite(res.id)">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z">
                            </path>
                        </svg>
                        <span class="btn-favorite-text" *ngIf="!isFavorite(res.id)">Favorite</span>
                        <span class="btn-favorite-text" *ngIf="isFavorite(res.id)">Unfavorite</span>
                    </button>
                </div>

                <!-- Metadata Grid (Duration, Level, Date) -->
                <div class="meta-grid mb-5">
                    <div class="meta-item" *ngIf="res.duration">
                        <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div class="meta-text">
                            <div class="meta-label">Duration</div>
                            <div class="meta-value">{{ res.duration }}</div>
                        </div>
                    </div>
                    <div class="meta-item" *ngIf="res.level">
                        <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20V10m6 10V4M6 20v-4" />
                        </svg>
                        <div class="meta-text">
                            <div class="meta-label">Level</div>
                            <div class="meta-value">{{ res.level }}</div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <path d="M16 2v4M8 2v4m-5 4h18" />
                        </svg>
                        <div class="meta-text">
                            <div class="meta-label">Published</div>
                            <div class="meta-value">{{ res.published | date:'longDate' }}</div>
                        </div>
                    </div>
                </div>


                <!-- =============================================
                     5. DYNAMIC CONTENT SWITCHER
                     ============================================= -->
                <div class="content-block" [ngSwitch]="res.format">

                    <!-- CASE 1: WEBSITE (External Link) -->
                    <div *ngSwitchCase="'Website'" class="website-card-wrapper">
                        <div class="website-card glass">
                            <div class="wc-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </div>
                            <div class="wc-content">
                                <h4 class="mb-1">External Resource</h4>
                                <p class="mb-3 small text-muted-app">This resource is hosted on an external website.</p>
                                <a [href]="res.url" target="_blank" rel="noopener noreferrer" class="btn-visit-website">
                                    Visit Website
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- CASE 2: VIDEO (Iframe) -->
                    <div *ngSwitchCase="'Video'" class="video-viewer">
                        <div class="video-container glass" *ngIf="safeVideoUrl() as url">
                            <iframe [src]="url" title="Video player" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        <div *ngIf="!safeVideoUrl()" class="error-panel py-4">
                            <p class="mb-0">Video URL is missing or invalid.</p>
                        </div>
                    </div>

                    <!-- CASE 3: PODCAST (Custom Audio Player) -->
                    <div *ngSwitchCase="'Podcast'" class="podcast-viewer">
                        <div class="audio-player glass">
                            <!-- Player Info -->
                            <div class="ap-info">
                                <div class="ap-icon" [class.pulsing]="isPlaying()">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z" />
                                    </svg>
                                </div>
                                <div class="ap-text">
                                    <div class="small text-muted-app mb-1" *ngIf="isPlaying()">NOW PLAYING</div>
                                    <div class="small text-muted-app mb-1" *ngIf="!isPlaying()">PAUSED</div>
                                    <div class="fw-bold">{{ res.title }}</div>
                                </div>
                            </div>

                            <!-- Custom Controls -->
                            <div class="ap-controls">
                                <!-- Play/Pause Toggle -->
                                <button class="btn-play-pause" (click)="toggleAudio()" aria-label="Toggle Play/Pause">
                                    <svg *ngIf="!isPlaying()" viewBox="0 0 24 24" fill="currentColor">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    <svg *ngIf="isPlaying()" viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="6" y="4" width="4" height="16"></rect>
                                        <rect x="14" y="4" width="4" height="16"></rect>
                                    </svg>
                                </button>

                                <!-- Seek Slider -->
                                <div class="ap-timeline">
                                    <span class="time-current">{{ currentTimeStr() }}</span>
                                    <input type="range" class="custom-range" min="0" max="100" step="0.001"
                                        [value]="currentProgress()" [style.--progress]="currentProgress() + '%'"
                                        (mousedown)="onDragStart()" (mouseup)="onDragEnd()" (touchstart)="onDragStart()"
                                        (touchend)="onDragEnd()" (input)="seekAudio($event)" aria-label="Seek audio">
                                    <span class="time-total">{{ durationStr() }}</span>
                                </div>
                            </div>

                            <!-- Hidden Native Audio Element (Driven by TS logic) -->
                            <audio #audioPlayer [src]="res.url" (timeupdate)="onAudioTimeUpdate()"
                                (loadedmetadata)="onAudioLoaded()" (ended)="onAudioEnded()"></audio>
                        </div>
                    </div>

                    <!-- CASE 4: ARTICLES & GUIDES (HTML Content) -->
                    <div *ngSwitchDefault class="article-reader">
                        <div class="article-content" [innerHTML]="safeHtmlContent()" *ngIf="res.content"></div>
                        <div *ngIf="!res.content" class="text-muted-app text-center py-5 fst-italic">
                            Preview text not available for this resource.
                        </div>
                    </div>

                </div>
                <!-- End Dynamic Content -->

            </div>
        </div>

    </div>
</div>